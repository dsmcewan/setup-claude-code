name: Integration Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-action:
    name: Test ${{ matrix.version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        version: [stable, latest, 2.0.25]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test action with ${{ matrix.version }} version
        uses: ./
        id: setup-claude
        with:
          version: ${{ matrix.version }}
          marketplaces: |
            anthropics/claude-code
            https://github.com/pleaseai/claude-code-plugins.git
          plugins: |
            agent-sdk-dev@claude-code-plugins
            spec-kit@pleaseai

      - name: Verify installation
        run: |
          echo "Cache hit: ${{ steps.setup-claude.outputs.cache-hit }}"
          echo "Version: ${{ steps.setup-claude.outputs.version }}"
          echo "Path: ${{ steps.setup-claude.outputs.claude-path }}"
          echo "Marketplaces added: ${{ steps.setup-claude.outputs.marketplaces_added }}"
          echo "Plugins installed: ${{ steps.setup-claude.outputs.plugins_installed }}"

          # Verify claude command works
          if ! command -v claude &> /dev/null; then
            echo "❌ Claude Code not found in PATH"
            exit 1
          fi

          claude --version
          echo "✅ Claude Code ${{ matrix.version }} is working!"

          # Verify marketplaces are installed
          echo ""
          echo "Checking marketplaces..."
          claude plugin marketplace list
